---
import { getTasks } from '../lib/tareas.js';

const url = Astro.request.url;
const filter = new URL(url).searchParams.get('filter') || 'all';

const tasks = getTasks();
const filteredTasks = tasks.filter(task =>
  filter === 'all' ||
  (filter === 'completed' && task.completed) ||
  (filter === 'pending' && !task.completed)
);

const activeClass = (target) => filter === target ? 'font-bold underline' : '';
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Gestión de Tareas</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body class="bg-pink-50 font-sans min-h-screen">
    <div class="max-w-xl mx-auto p-6 bg-white rounded-xl shadow-md mt-10 space-y-6">
      <h1 class="text-2xl font-bold text-center text-pink-600">Gestión de Tareas</h1>

      <img src="https://images.pexels.com/photos/7845451/pexels-photo-7845451.jpeg" alt="Tareas" class="rounded-md mx-auto" />

      <!-- Formulario para agregar tarea -->
      <form action="/api/add" method="POST" class="flex gap-2 mt-4">
        <input type="text" name="task" placeholder="Nueva tarea" required
          class="flex-grow p-2 border border-pink-300 rounded" />
        <button type="submit" class="bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600">Agregar</button>
      </form>

      <!-- Filtros -->
      <div class="flex justify-center gap-4 text-sm">
        <a href="/?filter=all" class={activeClass('all')}>Todas</a>
        <a href="/?filter=pending" class={activeClass('pending')}>Activas</a>
        <a href="/?filter=completed" class={activeClass('completed')}>Completadas</a>
      </div>

      <!-- Lista de tareas -->
      <ul class="space-y-2">
        {filteredTasks.map((task) => (
          <li class="flex items-center justify-between bg-pink-100 px-4 py-2 rounded">
            <!-- Cambiar estado -->
            <form action="/api/toggle" method="POST">
              <input type="hidden" name="taskId" value={task.id} />
              <button type="submit" class="flex items-center gap-2">
                <span class={task.completed ? "line-through text-gray-500" : ""}>{task.name}</span>
              </button>
            </form>

            <!-- Eliminar -->
            <form action="/api/delete" method="POST">
              <input type="hidden" name="taskId" value={task.id} />
              <button type="submit" class="text-pink-500 hover:text-pink-700">✖</button>
            </form>
          </li>
        ))}
      </ul>

      <!-- Limpiar completadas -->
      <form action="/api/delete-completed" method="POST" class="text-center">
        <button type="submit" class="mt-4 text-sm text-white bg-pink-500 px-3 py-1 rounded hover:bg-pink-600">
          Limpiar completadas
        </button>
      </form>
    </div>

    <script>
      // Mejora progresiva con AJAX
      document.addEventListener('submit', async (e) => {
        const form = e.target;
        if (form.action.includes('/api/')) {
          e.preventDefault();
          const formData = new FormData(form);
          await fetch(form.action, {
            method: form.method,
            body: formData,
          });
          location.reload(); // Refresca la vista
        }
      });
    </script>
  </body>
</html>
